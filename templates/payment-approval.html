{% extends "layout-main.html" %}
{% block head %}
{{ super() }}

<script src="static/script/numberWithSpaces.js"></script>

<script src="static/script/paymentApprovalSaveChanges.js"></script>
<script src="static/script/paymentApprovalRecalcCards.js"></script>
<script src="static/script/paymentApprovalColorize.js"></script>



<!-- Коля вынеси потом это в один скрипт editingTabularData.js или скооперируй с моим test.html -->
<script src="static/script/application_modal.js"></script>
<script>
    function getModal() {
        $.ajax({
            url: '/open_modal',
            type: 'GET',
            dataType: 'html'
        }).then(data => {
            $('#myModal.modal-content').html(data);
            $('#myModal').modal('show');
        });
    }
</script>
<script>
    (function () {
        var cancelButton = document.getElementById("cancel");
        var favDialog = document.getElementById("payment-approval__dialog");
        cancelButton.addEventListener("click", function () {
            favDialog.close();
        });
    })();
</script>
<!-- Срабатывание ссылки на всю ячейку нужно убирать - иногда работает на заголовке + слайд на маленьких разрешениях невозможен -->
<!-- Варианты разрешения конфликта: надписи делать ссылками или добавить кнопочку вертикальное троеточие -->
<!-- Починить условное форматирование (!)-->



<body id="payment-approval_page">

    {% endblock %}
    {% block content %}


    <dialog class="window" id="payment-approval__dialog">
        <div id="payment-approval__dialog__menu">
            <div id="payment-approval__dialog__menu__edit">
                <h1><img src="static/img/h1/edit_pay.png"> Редактировать платёж</h1>
                <form id="new_payment" method="POST" action="/new-payment2">
                    <p><label for="basis_of_payment">Наименование платежа:</label>
                        <textarea name="basis_of_payment" id="basis_of_payment" rows="1" required>
                </textarea>
                    <div><label for="responsible">Ответственный:</label>
                        <select name="responsible" id="responsible" required>
                            <option>-</option>
                        </select>
                    </div>
                    <div class="unitedform">
                        <div><label for="cost_items">Тип заявки:</label>
                            <select name="cost_items" id="cost_items" required>

                                <option></option>

                                <optgroup label="">

                                    <option value=""></option>

                                </optgroup>
                            </select>
                        </div>
                        <div class="hidden_label" id="objects_name_div">
                            <label for="objects_name" id="objects_name_label">Объект:</label>
                            <select name="objects_name" id="objects_name">
                                <option value=""></option>
                            </select>
                        </div>
                    </div>
                    <p><label for="payment_description">Описание:</label>
                        <textarea name="payment_description" id="payment_description" rows="4" required></textarea>
                    </p>
                    <div><label for="partners">Контрагент:</label>
                        <input type="text" name="partners" id="partners" list="partners_name" value="">
                        <datalist id="partners_name">
                            <option></option>

                        </datalist>
                    </div>
                    <div><label for="payment_due_date">Срок оплаты:</label>
                        <input type="date" name="payment_due_date" id="payment_due_date" value="" required>
                    </div>
                    <div><label for="our_company">Компания:</label>
                        <select name="our_company" id="our_company" required>

                            <option value=""></option>

                        </select>
                    </div>
                    <div><label for="payment_sum">Сумма оплаты:</label>
                        <input type="text" placeholder="руб." name="payment_sum" id="payment_sum" onchange="numberWithSpaces(event, ' руб.')" value=""
                            required />
                    </div>
                    <div class="button_group">
                        <button id="cancel__edit_btn">Отменить редактирование</button>
                        <div class="button_group_2b">
                            <button id="delete__edit_btn">Анулировать</button>
                            <button id="save__edit_btn">Сохранить</button>
                        </div>
                    </div>
                </form>
            </div>
            <div id="payment-approval__dialog__menu__list">
                <h2><img src="static/img/h1/history.png"> История платежей</h2>
            </div>
        </div>
    </dialog>






    <div class="tpages_top_panel">
        <h1><img src="static/img/h1/payment-approval.png"> {{title}}</h1>
        <div class="cards-container">
            <div class="card" id="card_selected_for_approval">
                <div class="cards_h1_border">
                    <h2 class="card-title" id="card_selected_for_approval_value">&nbsp;</h2>
                </div>
                <div>
                    <p class="card-cost">Выбрано для одобрения</p>
                </div>
            </div>
            <div class="card" id="card_available_money">
                <div class="cards_h1_border">
                    <h2 class="card-title" id="card_available_money_value" data-value="{{ available_money }}">{{ available_money }} ₽</h2>
                </div>
                <div>
                    <p class="card-cost">Доступные к распределению</p>
                </div>
            </div>
            <div class="card" id="card_account_money">
                <div class="cards_h1_border">
                    <h2 class="card-title" id="card_account_money_value" data-value="{{ account_money }}">{{ account_money }} ₽</h2>
                </div>
                <div>
                    <p class="card-cost">На счету</p>
                </div>
            </div>
        </div>
        <div id="payment-approval__menu">
            <div class="not_form_button focus_button">Согласование платежей</div>
            <div class="not_form_button"><a href="payment-approval-list">Согласованные платежи</a> </div>
            <div class="not_form_button"><a href="payment-paid-list">Оплаченные платежи</a></div>
        </div>
    </div>




    <form id="paymentForm" action="/payment-approval" method="POST" style="align-self: flex-start">
        <button type="submit">Отправить</button>

        <table id="payment-table" name="payment_table" class="display">
            <thead>
                <tr>
                    <th class="th_select">ВЫБОР</th>
                    <th class="th_category">СТАТЬЯ ЗАТРАТ</th>
                    <th class="th_name">НАИМЕНОВАНИЕ ПЛАТЕЖА</th>
                    <th class="th_discription">ОПИСАНИЕ</th>
                    <th class="th_object">ОБЪЕКТ</th>
                    <th class="th_responsible">ОТВЕТСТВЕННЫЙ</th>
                    <th class="th_contractor">КОНТРАГЕНТ</th>
                    <th class="th_main_sum">ОБЩАЯ СУММА</th>
                    <th class="th_sum_remain">ОСТАТОК К ОПЛАТЕ</th>
                    <th class="th_sum_agreed">СОГЛАСОВАННАЯ СУММА</th>
                    <th class="th_pay_date">СРОК ОПЛАТЫ</th>
                    <th class="th_status">СТАТУС</th>
                    <th class="th_date_create">ДАТА СОЗДАНИЯ</th>
                    <th class="th_save_pay">ДО ПОЛНОЙ ОПЛАТЫ</th>
                </tr>
            </thead>
            <tbody>
                {% for application in applications %}
                <tr id="row-{{ loop.index }}">
                    <td class="th_select_i" data-sort={{ loop.index }}>
                        <input type="checkbox" id="selectedRows-{{ loop.index }}" name="selectedRows" value="{{loop.index}}"
                            onchange="paymentApprovalRecalcCards({{ loop.index }})">
                    </td>
                    <td class="th_category_i" data-sort="{{ application.cost_item_name }}">{{
                        application.cost_item_name }}</td>
                    <td class="th_name_i" data-sort="{{application.basis_of_payment}}" title="{{ application.basis_of_payment }}"
                        onclick="window['payment-approval__dialog'].showModal()">{{
                        application.basis_of_payment_short }}</td>
                    <td class="th_discription_i" data-sort="{{application.basis_of_payment}}" title="{{ application.payment_description }}"><span
                            class="paymentFormBold">{{ application.contractor_name }}: </span>{{
                        application.payment_description_short }}</td>
                    <td class="th_object_i" data-sort="{{application.object_name}}">{{ application.object_name
                        }}
                    </td>
                    <td class="th_responsible_i">{{ application.last_name }} {{ application.first_name[0] }}.</td>
                    <td class="th_contractor_i">{{ application.partner }}</td>
                    <td class="th_main_sum_i">{{ application.payment_sum_rub }}</td>
                    <td class="th_sum_remain_i">
                        <input id="approvalSum-{{ loop.index }}" name="approval_sum" value="{{application.approval_sum}}" hidden readonly>
                        {{ application.approval_sum_rub}}
                    </td>
                    <td class="th_sum_agreed_i">
                        <input id="amount-{{ loop.index }}" name="amount" value="{{ application.amount_rub }}" data-amount=0
                            onchange="saveData({{ loop.index }}, '{{ page }}')">
                    </td>
                    <td class="th_pay_date_i">{{ application.payment_due_date }}</td>
                    <td class="th_status_i" id="status-{{ loop.index }}">
                        <select id="status_id-{{ loop.index }}" name="status_id" data-amount="{{ 444 if application.status_id==4 else 33333}}"
                            onchange="paymentApprovalRecalcCards({{ loop.index }}), saveData({{ loop.index }}, '{{ page }}')">
                            {% for s in approval_statuses %}
                            <option {% if application.status_id==s.payment_agreed_status_id %} selected {% endif %}>
                                {{ s.payment_agreed_status_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="th_date_create_i">{{ application.payment_at }}</td>
                    <td class="th_save_pay_i">
                        <input type="checkbox" id="paymentFullStatus-{{ loop.index }}" name="payment_full_agreed_status" value="{{loop.index}}" {% if
                            application.payment_full_agreed_status %}checked{% endif %}
                            onchange="saveData({{ loop.index }}, '{{ page }}'), tabColorize({{ loop.index }})">
                    </td>
                </tr>

                {% endfor %}
            </tbody>
        </table>
    </form>
    {% endblock %}

</body>